---
title: "Analyse species distribution data per province "
editor_options:
  chunk_output_type: console
---


We intersected the polygon of _Marine provinces_ from [MEOW](https://www.worldwildlife.org/publications/marine-ecoregions-of-the-world-a-bioregionalization-of-coastal-and-shelf-areas) and species distribution records from GBIF

We run a script to download GBIF data in the background.

```sh
cd $WORKDIR
nohup Rscript $SCRIPTDIR/inc/R/download-from-GBIF.R > nohup-gbif-qries.out &
```

We then use rsync to update the results in the shared drive

```sh
export srcdir=$GISDATA/species-dist/global/GBIF/
export dstdir=$zID@kdm.restech.unsw.edu.au:/srv/scratch/cesdata/gisdata/species-dist/global/GBIF
# this is a dry run: remove -n flag for actual syncing
rsync -gloptrunv $srcdir/* $dstdir 
```

We create a 1-degree grid on top of marine provinces. For the cells belonging to those we count the number of records per species and create a matrix species by grid cell.

Preview list of associated species
```{r}
head(res)
table(res$kingdom_name,res$habitat)

res %>% group_by(class_name) %>% summarise(total=n_distinct(scientific_name))

res %>% group_by(order_name) %>% summarise(total=n_distinct(scientific_name))
res %>% group_by(order_name) %>% summarise(total=n_distinct(scientific_name)) %>% arrange(desc(total))
```

Check first how many records are available in GBIF for each species:

```{r}


summary(res$gbif_records)
summary(res$gbif_xy_records)
```


```{r}
```


```{r}

```


```{r}


```

and other species...

```{r}
```


```{r}


all_occs <- ls(pattern="occ_data")
lst <- mget(all_occs)

gbif_qry <- bind_cols(
  order_names=gsub("occ_data_","",names(lst)),
  found=sapply(lst,function(x) x$gbif$meta$found,simplify=T), returned=sapply(lst,function(x) x$gbif$meta$returned,simplify=T))

gbif_qry %>% filter(found<=returned) %>% pull(order_names) -> listos
gbif_qry %>% filter(found<(2*returned) & !(order_names %in% listos))

tst <- occ2df(occ_data_ACCIPITRIFORMES) 
plot(latitude~longitude,tst)

#occ_data$gbif$data$Zenarchopterus_buffonis %>% select(longitude,latitude,countrycode,higherGeography)

```

---
title: |
  ![](logo.png){width=1in}
  MFT1.2 Intertidal Forest and Shrublands
subtitle: "Red List of Ecosystem assessments"
author: "JR Ferrer-Paris"
date: "17/08/2021"
output: html_document
runtime: shiny
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
require(dplyr)
require(units)
require(leaflet)
require(DT)
require(sf)
options(dplyr.summarise.inform = FALSE)
load('dbquery.rda')
```

# IUCN RLE database
The [IUCN Red List of Ecosystems database](https://assessments.iucnrle.org) is an on-going effort to document all IUCN RLE assessments. 

## List of publications with assessments 

Here we show a selection of references that include assessments of Mangrove units. Some of these references are systematic assessments of terrestrial or marine ecosystems at a national or continental scale. Other references describe strategic assessment of selected local/regional units. 

```{r}
lks <- asm_links %>% filter(is.na(eco_id)) %>% transmute(asm_id, url=sprintf("<a href='%s' target='_blank'>%s</a>",URLdecode(url),url_description)) %>% group_by(asm_id) %>% summarise(links=paste(url,collapse=" :: ")) 

asms <- assessments %>% left_join(lks,by="asm_id") %>% transmute(`Reference`=ref_code,`Assessment`=name,`Protocol`=assessment_protocol_code,`Link`=links)

DT::datatable(asms,escape=FALSE)
```

## Assessment units
Some of the assessments above include multiple units, and some units are distributed across multiple countries. The list of assessment units can be filtered by country using the ISO two letter code. The table includes links to assessment information or documents where these are available.

```{r}

lks <- asm_links %>% filter(!is.na(eco_id)) %>% transmute(eco_id, url=sprintf("<a href='%s' target='_blank'>%s</a>", URLdecode(url), url_description)) %>% group_by(eco_id) %>% summarise(links=paste(url, collapse=" :: ")) 


au <- asm_units %>% mutate(iso2=strsplit(gsub("\\{|\\}","",asm_units$countries),",")) %>% left_join(lks,by='eco_id')

slc.countries <- unique(unlist(au %>% select(iso2)))

selectInput("country", "Countries and territories",
                         structure(slc.countries,
                                   names=slc.countries), multiple=TRUE)


## add filter by category? level?

DT::renderDataTable({
  if (is.null(input$country)) { 
    ss <- rep(TRUE,nrow(au))
  } else { 
    ss <-   sapply(au$iso2,function(x) any(x %in% input$country),simplify=T) 
  }

  au %>% 
    filter(ss) %>%
    transmute(name=eco_name_orig, lang=eco_name_lang, Reference=ref_code, level, category=overall_risk_category, bounds=risk_category_bounds, links)
  },escape=FALSE)
```

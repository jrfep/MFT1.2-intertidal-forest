---
title: |
  ![](logo.png){width=1in}
  MFT1.2 Intertidal Forest and Shrublands
subtitle: "Red List of Ecosystem assessments"
author: "JR Ferrer-Paris"
date: "17/08/2021"
output: html_document
runtime: shiny
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
require(dplyr)
require(units)
require(leaflet)
library(RPostgreSQL)
require(DT)
require(sf)
options(dplyr.summarise.inform = FALSE)
```


```{r,echo=FALSE}

if (file.exists("~/.database.ini")) {
   tmp <-     system("grep -A5 psqlaws $HOME/.database.ini",intern=TRUE)[-1]
   dbinfo <- gsub("[a-z]+=","",tmp)
   names(dbinfo) <- gsub("([a-z]+)=.*","\\1",tmp)

   drv <- dbDriver("PostgreSQL") ## remember to update .pgpass file
   con <- dbConnect(drv, dbname = dbinfo["database"],
                 host = dbinfo["host"], port = dbinfo["port"],
                 user = dbinfo["user"], password = dbinfo["password"])

    prg <- 
    "SELECT eco_id, eco_name, eco_name_orig, eco_name_lang, u.countries, level, membership, assigned_by, asm_id, assessment_date, overall_risk_category, risk_category_bounds,ref_code
FROM rle.assessment_get_xwalk x
LEFT JOIN rle.assessment_units u USING(eco_id) 
LEFT JOIN rle.assessment_overall o USING(eco_id) 
LEFT JOIN rle.assessments a USING(asm_id)
WHERE efg_code = 'MFT1.2'"
    
asm_units <- dbGetQuery(con,prg)
    
  prg <- 
    "SELECT eco_id, eco_name, eco_name_orig, eco_name_lang, u.countries, level, membership, assigned_by, asm_id, assessment_date, overall_risk_category, risk_category_bounds,ref_code,u.xy_geom as geometry
FROM rle.assessment_get_xwalk x
LEFT JOIN rle.assessment_units u USING(eco_id) 
LEFT JOIN rle.assessment_overall o USING(eco_id) 
LEFT JOIN rle.assessments a USING(asm_id)
WHERE efg_code = 'MFT1.2' AND u.xy_geom IS NOT NULL"
    
asm_xy <- read_sf(con,query=prg)    
    
prg <- sprintf("SELECT l.eco_id,asm_id,url,url_description,ref_code,eco_name_orig FROM rle.assessment_links l LEFT JOIN rle.assessments a USING(asm_id) LEFT JOIN rle.assessment_units u ON l.eco_id=u.eco_id  WHERE l.eco_id IN ('%s') OR (l.eco_id IS NULL AND asm_id IN ('%s'))", paste(asm_units$eco_id, collapse="','"), paste(unique(asm_units$asm_id), collapse="','"))

asm_links <- dbGetQuery(con,prg)

prg <- sprintf("SELECT asm_id,ref_code,assessment_protocol_code,risk_category_code,name,countries,asm_type,status FROM rle.assessments WHERE asm_id IN ('%s')", paste(asm_units$asm_id, collapse="','"))

assessments <- dbGetQuery(con,prg)



prg <- sprintf("SELECT * FROM ref_list WHERE ref_code IN ('%s')", paste(assessments$ref_code, collapse="','"))

references <- dbGetQuery(con,prg)
dbDisconnect(con)

save(file='dbquery.rda',asm_units,asm_links,assessments,references,asm_xy)
} else {
  load(file='dbquery.rda')
}

```

Let's have a look at the assessments

```{r}
lks <- asm_links %>% filter(is.na(eco_id)) %>% transmute(asm_id, url=sprintf("<a href='%s' target='_blank'>%s</a>",URLdecode(url),url_description)) %>% group_by(asm_id) %>% summarise(links=paste(url,collapse=" :: ")) 

asms <- assessments %>% left_join(lks,by="asm_id") %>% transmute(`Reference`=ref_code,`Assessment`=name,`Protocol`=assessment_protocol_code,`Link`=links)

DT::datatable(asms,escape=FALSE)
```


These are the assessment units included

```{r}

lks <- asm_links %>% filter(!is.na(eco_id)) %>% transmute(eco_id, url=sprintf("<a href='%s' target='_blank'>%s</a>", URLdecode(url), url_description)) %>% group_by(eco_id) %>% summarise(links=paste(url, collapse=" :: ")) 


au <- asm_units %>% mutate(iso2=strsplit(gsub("\\{|\\}","",asm_units$countries),",")) %>% left_join(lks,by='eco_id')

slc.countries <- unique(unlist(au %>% select(iso2)))

selectInput("country", "Countries and territories",
                         structure(slc.countries,
                                   names=slc.countries), multiple=TRUE)


## add filter by category? level?

DT::renderDataTable({
  if (is.null(input$country)) { 
    ss <- rep(TRUE,nrow(au))
  } else { 
    ss <-   sapply(au$iso2,function(x) any(x %in% input$country),simplify=T) 
  }

  au %>% 
    filter(ss) %>%
    transmute(name=eco_name_orig, lang=eco_name_lang, Reference=ref_code, level, category=overall_risk_category, bounds=risk_category_bounds, links)
  },escape=FALSE)
```

Add map with locations? countries?

```{r}
plot(st_geometry(asm_xy))
```